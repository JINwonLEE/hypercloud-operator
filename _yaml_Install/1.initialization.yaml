apiVersion: v1
kind: Namespace
metadata:
  name: hypercloud4-system

---

apiVersion: v1
kind: ResourceQuota
metadata:
  name: hypercloud4-system-quota
  namespace: hypercloud4-system
spec:
  hard:
    limits.cpu: "2"
    limits.memory: "10Gi"
    requests.storage: "20Gi"

---

apiVersion: v1
kind: ServiceAccount
metadata:
  name: hypercloud4-admin
  namespace: hypercloud4-system

---

apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: hypercloud4-admin
  namespace: hypercloud4-system
rules:
  - apiGroups: ["*"]
    resources: ["*"]
    verbs: ["*"]

---

kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: hypercloud4-admin
subjects:
  - kind: ServiceAccount
    name: hypercloud4-admin
    namespace: hypercloud4-system
roleRef:
  kind: ClusterRole
  name: hypercloud4-admin
  apiGroup: rbac.authorization.k8s.io
  
---

apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: users.tmax.io
spec:
  group: tmax.io
  versions:
    - name: v1
      served: true
      storage: true
  scope: Cluster
  names:
    plural: users
    singular: user
    kind: User
    shortNames:
    - user
  preserveUnknownFields: false
  validation:
    openAPIV3Schema:
      type: object
      required: [userInfo, status]
      properties:
        userInfo:
          type: object
          required: [name, password, email, phone]
          description: UserInfo contains user information
          properties:
            name:
              type: string
            password:
              type: string
            passwordSalt:
              type: string
            email:
              type: string
            phone:
              type: string 
            department:
              type: string
            position:
              type: string
            description:
              type: string
        status:
          type: string
          description: Status defines whether the user is active or blocked
          enum: [active, blocked]
          
---

apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: tokens.tmax.io
spec:
  group: tmax.io
  versions:
    - name: v1
      served: true
      storage: true
  scope: Cluster
  names:
    plural: tokens
    singular: token
    kind: Token
    shortNames:
    - token
  preserveUnknownFields: false
  validation:
    openAPIV3Schema:     
        type: object
        required: [accessToken, refreshToken]
        description: Token contains encrypted access token and refresh token
        properties:
          accessToken:
            type: string
          refreshToken:
            type: string

---

apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: templates.tmax.io
spec:
  group: tmax.io
  versions:
  - name: v1
    served: true
    storage: true
  scope: Namespaced
  names:
    plural: templates
    singular: template
    kind: Template
    shortNames:
    - tp
  preserveUnknownFields: true
  validation:
    openAPIV3Schema:
      type: object
      properties:
        apiVersion:
          type: string
        kind:
          type: string
        labels:
          additionalProperties:
            type: string
          type: object
        message:
          type: string
        metadata:
          properties:
            generateName:
              type: string
            name:
              type: string
          type: object
        objects:
          items:
            type: object
            x-kubernetes-preserve-unknown-fields: true
          type: array
        parameters:
          items:
            properties:
              description:
                type: string
              displayName:
                type: string
              from:
                type: string
              generate:
                type: string
              name:
                type: string
              required:
                type: boolean
              value:
                type: string
            required:
            - name
            type: object
          type: array

---

apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: templateinstances.tmax.io
spec:
  group: tmax.io
  versions:
  - name: v1
    served: true
    storage: true
  scope: Namespaced
  names:
    plural: templateinstances
    singular: templateinstance
    kind: TemplateInstance
    shortNames:
    - ti
  preserveUnknownFields: true
  validation:
    openAPIV3Schema:
        type: object
        properties:
          apiVersion:
            type: string
          kind:
            type: string
          metadata:
            properties:
              generateName:
                type: string
              name:
                type: string
            type: object
          spec:
            type: object
            properties:
              requester:
                type: object
                properties:
                  extra:
                    type: object
                    #x-kubernetes-embedded-resource: true
                    x-kubernetes-preserve-unknown-fields: true
                  groups:
                    type: array
                    items:
                      type: string
                  uid:
                    type: string
                  username:
                    type: string
              secret:
                type: object
                properties:
                  name:
                    type: string
              template:
                type: object
                properties:
                  apiVersion:
                    type: string
                  kind:
                    type: string
                  labels:
                    additionalProperties:
                      type: string
                    type: object
                  message:
                    type: string
                  metadata:
                    properties:
                      generateName:
                        type: string
                      name:
                        type: string
                    type: object
                  objects:
                    items:
                      type: object
                      x-kubernetes-embedded-resource: true
                      x-kubernetes-preserve-unknown-fields: true
                    type: array
                  parameters:
                    items:
                      properties:
                        description:
                          type: string
                        displayName:
                          type: string
                        from:
                          type: string
                        generate:
                          type: string
                        name:
                          type: string
                        required:
                          type: boolean
                        value:
                          type: string
                      required:
                      - name
                      type: object
                    type: array
          status:
            type: object
            properties:
              conditions:
                items:
                  properties:
                    lastTransitionTime:
                      format: date-time
                      type: string
                    message:
                      type: string
                    reason:
                      type: string
                    status:
                      type: string
                    type:
                      type: string
                  required:
                    - type
                  type: object
                type: array
              objects:
                items:
                  properties:
                    ref:
                      type: object
                      properties:
                        apiVersion:
                          type: string
                        fieldPath:
                          type: string
                        kind:
                          type: string
                        name:
                          type: string
                        namespace:
                          type: string
                        resourceVersion:
                          type: string
                        uid:
                          type: string
                  required:
                  - ref
                  type: object
                type: array
  subresources:
    status: {}

---

apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: registries.tmax.io
spec:
  group: tmax.io
  versions:
    - name: v1
      served: true
      storage: true
  scope: Namespaced
  names:
    plural: registries
    singular: registry
    kind: Registry
    shortNames:
    - reg
  preserveUnknownFields: false
  validation:
    openAPIV3Schema:
      type: object
      required: [spec]
      properties:
        spec:
          type: object
          required: [image, loginId, loginPassword, storageSize]
          description: registry information
          properties:
            image:
              type: string
            description:
              type: string
            loginId:
               type: string
            loginPassword:
               type: string
            storageSize:
              type: string
        status:
          type: object
          required: [phase]
          properties:
             message:
               type: string
             phase:
               type: string
               enum: [Creating, Running, Failed]
             reason:
               type: string
  additionalPrinterColumns:
  - name: Image
    type: string
    description: Registry Image
    JSONPath: .spec.image
  - name: Capacity
    type: string
    description: Registry PVC Size
    JSONPath: .spec.storageSize
  - name: Status
    type: string
    description: Registry Status
    JSONPath: .status.phase
  - name: Age
    type: date
    JSONPath: .metadata.creationTimestamp

---

apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: namespaceclaims.tmax.io
spec:
  group: tmax.io
  versions:
  - name: v1
    served: true
    storage: true
  scope: Cluster
  names:
    plural: namespaceclaims
    singular: namespaceclaim
    kind: NamespaceClaim
    shortNames:
    - nsc
  preserveUnknownFields: true
  validation:
    openAPIV3Schema:
        # Users use namespaceclaim to request namespace and quotas.
        # The spec of namespaceclaim is the same as resourcequota.
        # Admins can change the 'status' of the namespaceclaim.
        # If Admin change the Status to 'Success', a namespace and resourcequota are created.
        type: object
        required: [apiVersion,kind,metadata,spec]
        properties:
          apiVersion:
            type: string
          kind:
            type: string
          metadata:
            type: object
            properties:
              name:
                type: string
          spec:
            # Equal Resource Quota Spec
            type: object
            properties:
              hard:
                type: object
                properties:
                  limits.cpu:
                    x-kubernetes-int-or-string: true
                    type: number
                  limits.memory:
                    x-kubernetes-int-or-string: true
                  requests.cpu:
                    x-kubernetes-int-or-string: true
                    type: number
                  requests.memory:
                    x-kubernetes-int-or-string: true
                  requests.nvidia.com/gpu:
                    x-kubernetes-int-or-string: true
                    type: number
                  requests.storage:
                    x-kubernetes-int-or-string: true
                  persistentvolumeclaims:
                    type: integer
                  <storage-class-name>.storageclass.storage.k8s.io/requests.storage:
                    x-kubernetes-int-or-string: true
                  <storage-class-name>.storageclass.storage.k8s.io/persistentvolumeclaims:
                    type: integer
                  requests.ephemeral-storage:
                    x-kubernetes-int-or-string: true
                  limits.ephemeral-storage:
                    x-kubernetes-int-or-string: true
                  count/persistentvolumeclaims:
                    type: integer
                  count/services:
                    type: integer
                  count/secrets:
                    type: integer
                  count/configmaps:
                    type: integer
                  count/replicationcontrollers:
                    type: integer
                  count/deployments.apps:
                    type: integer
                  count/replicasets.apps:
                    type: integer
                  count/statefulsets.apps:
                    type: integer
                  count/jobs.batch:
                    type: integer
                  count/cronjobs.batch:
                    type: integer
                  count/deployments.extensions:
                    type: integer
                  configmaps:
                    type: integer
                  pods:
                    type: integer
                  replicationcontrollers:
                    type: integer
                  resourcequotas:
                    type: integer
                  services:
                    type: integer
                  services.loadbalancers:
                    type: integer
                  services.nodeports:
                    type: integer
                  secrets:
                    type: integer
          status:
            type: object
            properties:
              lastTransitionTime:
                format: date-time
                type: string
              message:
                type: string
              reason:
                type: string
              status:
                type: string
                enum:
                  - Awaiting
                  - Success
                  - Reject
                  - Error
  additionalPrinterColumns:
  - name: Status
    type: string
    JSONPath: .status.status
  - name: Reason
    type: string
    JSONPath: .status.reason
  subresources:
    status: {}

---

apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: resourcequotaclaims.tmax.io
spec:
  group: tmax.io
  versions:
  - name: v1
    served: true
    storage: true
  scope: Namespaced
  names:
    plural: resourcequotaclaims
    singular: resourcequotaclaim
    kind: ResourceQuotaClaim
    shortNames:
    - rqc
  preserveUnknownFields: true
  validation:
    openAPIV3Schema:
        # Users use resourcequotaclaim to modify quotas.
        # The spec of resourcequotaclaim is the same as resourcequota.
        # Admins can change the 'status' of the resourcequotaclaim.
        # If Admin change the Status to 'Success', resourcequota is updated.
        type: object
        required: [apiVersion,kind,metadata,spec]
        properties:
          apiVersion:
            type: string
          kind:
            type: string
          metadata:
            type: object
            properties:
              name:
                type: string
          spec:
            # Equal Resource Quota
            type: object
            properties:
              hard:
                type: object
                properties:
                  limits.cpu:
                    x-kubernetes-int-or-string: true
                    type: number
                  limits.memory:
                    x-kubernetes-int-or-string: true
                  requests.cpu:
                    x-kubernetes-int-or-string: true
                    type: number
                  requests.memory:
                    x-kubernetes-int-or-string: true
                  requests.nvidia.com/gpu:
                    x-kubernetes-int-or-string: true
                    type: number
                  requests.storage:
                    x-kubernetes-int-or-string: true
                  persistentvolumeclaims:
                    type: integer
                  <storage-class-name>.storageclass.storage.k8s.io/requests.storage:
                    x-kubernetes-int-or-string: true
                  <storage-class-name>.storageclass.storage.k8s.io/persistentvolumeclaims:
                    type: integer
                  requests.ephemeral-storage:
                    x-kubernetes-int-or-string: true
                  limits.ephemeral-storage:
                    x-kubernetes-int-or-string: true
                  count/persistentvolumeclaims:
                    type: integer
                  count/services:
                    type: integer
                  count/secrets:
                    type: integer
                  count/configmaps:
                    type: integer
                  count/replicationcontrollers:
                    type: integer
                  count/deployments.apps:
                    type: integer
                  count/replicasets.apps:
                    type: integer
                  count/statefulsets.apps:
                    type: integer
                  count/jobs.batch:
                    type: integer
                  count/cronjobs.batch:
                    type: integer
                  count/deployments.extensions:
                    type: integer
                  configmaps:
                    type: integer
                  pods:
                    type: integer
                  replicationcontrollers:
                    type: integer
                  resourcequotas:
                    type: integer
                  services:
                    type: integer
                  services.loadbalancers:
                    type: integer
                  services.nodeports:
                    type: integer
                  secrets:
                    type: integer
          status:
            type: object
            properties:
              lastTransitionTime:
                format: date-time
                type: string
              message:
                type: string
              reason:
                type: string
              status:
                type: string
                enum:
                  - Awaiting
                  - Success
                  - Reject
                  - Error
  additionalPrinterColumns:
  - name: Status
    type: string
    JSONPath: .status.status
  - name: Reason
    type: string
    JSONPath: .status.reason
  subresources:
    status: {}

---

apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: rolebindingclaims.tmax.io
spec:
  group: tmax.io
  versions:
  - name: v1
    served: true
    storage: true
  scope: Namespaced
  names:
    plural: rolebindingclaims
    singular: rolebindingclaim
    kind: RoleBindingClaim
    shortNames:
    - rbc
  preserveUnknownFields: true
  validation:
    openAPIV3Schema:
        # Users use rolebindingclaim to request rolebinding.
        # subject and roleRef of rolebindingclaim is the same as rolebinding.
        # Admins or Owner can change the 'status' of the rolebindingclaim.
        # If change the Status to 'Success', rolebinding is created.
        type: object
        required: [apiVersion,kind,metadata,subjects,roleRef]
        properties:
          apiVersion:
            type: string
          kind:
            type: string
          metadata:
            type: object
            properties:
              name:
                type: string
          subjects:
            # Equal RoleBinding Subjects Spec
            type: array
            items:
              type: object
              required: [kind,name]
              properties:
                kind:
                  type: string
                name:
                  type: string
                apiGroup:
                  type: string
          roleRef:
            # Equal RoleBinding roleRef Spec
            type: object
            required: [kind,name,apiGroup]
            properties:
              kind:
                type: string
              name:
                type: string
              apiGroup:
                type: string
          status:
            type: object
            properties:
              lastTransitionTime:
                format: date-time
                type: string
              message:
                type: string
              reason:
                type: string
              status:
                type: string
                enum:
                  - Awaiting
                  - Success
                  - Reject
                  - Error
  additionalPrinterColumns:
  - name: Status
    type: string
    JSONPath: .status.status
  - name: Reason
    type: string
    JSONPath: .status.reason
  subresources:
    status: {}