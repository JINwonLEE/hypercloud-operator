apiVersion: v1
kind: Namespace
metadata:
  name: hypercloud4-system

---

apiVersion: v1
kind: ResourceQuota
metadata:
  name: hypercloud4-system-quota
  namespace: hypercloud4-system
spec:
  hard:
    limits.cpu: "3"
    limits.memory: "15Gi"
    requests.storage: "30Gi"

---

apiVersion: v1
kind: ServiceAccount
metadata:
  name: hypercloud4-admin
  namespace: hypercloud4-system

---

apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: hypercloud4-admin
  namespace: hypercloud4-system
rules:
  - apiGroups: ["*"]
    resources: ["*"]
    verbs: ["*"]

---

kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: hypercloud4-admin
subjects:
  - kind: ServiceAccount
    name: hypercloud4-admin
    namespace: hypercloud4-system
roleRef:
  kind: ClusterRole
  name: hypercloud4-admin
  apiGroup: rbac.authorization.k8s.io
  
---

apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: users.tmax.io
spec:
  group: tmax.io
  versions:
    - name: v1
      served: true
      storage: true
  scope: Cluster
  names:
    plural: users
    singular: user
    kind: User
    shortNames:
    - user
  preserveUnknownFields: false
  validation:
    openAPIV3Schema:
      # required 'metadata.labels.encrypted: f'
      # metadata.name ex) admin-tmax.co.kr -> @ Must be entered as -
      # userInfo.email ex) admin@tmax.co.kr -> Email and name should be the same
      # The user controller will encrypt the password and update label 'encrypted: t'
      type: object
      required: [userInfo, status]
      properties:
        userInfo:
          type: object
          required: [name, password, email, phone]
          description: UserInfo contains user information
          properties:
            name:
              type: string
              description: user's name
            password:
              type: string
              description: user's password
            passwordSalt:
              type: string
              description: do not enter
            email:
              type: string
              description: user's email for login
            phone:
              type: string
              description: user's phone number
            department:
              type: string
              description: user's department
            position:
              type: string
              description: user's position
            description:
              type: string
              description: description
        status:
          type: string
          description: Status defines whether the user is active or blocked
          enum: [active, blocked]
          
---

apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: tokens.tmax.io
spec:
  group: tmax.io
  versions:
    - name: v1
      served: true
      storage: true
  scope: Cluster
  names:
    plural: tokens
    singular: token
    kind: Token
    shortNames:
    - token
  preserveUnknownFields: false
  validation:
    openAPIV3Schema:     
        type: object
        required: [accessToken, refreshToken]
        description: Token contains encrypted access token and refresh token
        properties:
          accessToken:
            type: string
          refreshToken:
            type: string

---

apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: templates.tmax.io
spec:
  group: tmax.io
  versions:
  - name: v1
    served: true
    storage: true
  scope: Namespaced
  names:
    plural: templates
    singular: template
    kind: Template
    shortNames:
    - tp
  preserveUnknownFields: true
  validation:
    openAPIV3Schema:
      type: object
      properties:
        apiVersion:
          type: string
        kind:
          type: string
        labels:
          additionalProperties:
            type: string
          type: object
        shortDescription:
          type: string
        longDescription:
          type: string
        provider:
          type: string
        imageUrl:
          type: string
        recommend:
          type: boolean
        tags:
          type: array
          items:
            type: string
        objectKinds:
          type: array
          items:
            type: string
        metadata:
          properties:
            generateName:
              type: string
            name:
              type: string
          type: object
        objects:
          items:
            type: object
            x-kubernetes-preserve-unknown-fields: true
          type: array
        plans:
          type: array
          items:
            type: object
            x-kubernetes-preserve-unknown-fields: true
        parameters:
          items:
            properties:
              description:
                type: string
              displayName:
                type: string
              from:
                type: string
              generate:
                type: string
              name:
                type: string
              required:
                type: boolean
              value:
                x-kubernetes-int-or-string: true
            required:
            - name
            type: object
          type: array

---

apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: templateinstances.tmax.io
spec:
  group: tmax.io
  versions:
  - name: v1
    served: true
    storage: true
  scope: Namespaced
  names:
    plural: templateinstances
    singular: templateinstance
    kind: TemplateInstance
    shortNames:
    - ti
  preserveUnknownFields: true
  validation:
    openAPIV3Schema:
        type: object
        properties:
          apiVersion:
            type: string
          kind:
            type: string
          metadata:
            properties:
              generateName:
                type: string
              name:
                type: string
            type: object
          spec:
            type: object
            properties:
              requester:
                type: object
                properties:
                  extra:
                    type: object
                    #x-kubernetes-embedded-resource: true
                    x-kubernetes-preserve-unknown-fields: true
                  groups:
                    type: array
                    items:
                      type: string
                  uid:
                    type: string
                  username:
                    type: string
              secret:
                type: object
                properties:
                  name:
                    type: string
              template:
                type: object
                properties:
                  apiVersion:
                    type: string
                  kind:
                    type: string
                  labels:
                    additionalProperties:
                      type: string
                    type: object
                  message:
                    type: string
                  metadata:
                    properties:
                      generateName:
                        type: string
                      name:
                        type: string
                    type: object
                  objects:
                    items:
                      type: object
                      x-kubernetes-embedded-resource: true
                      x-kubernetes-preserve-unknown-fields: true
                    type: array
                  parameters:
                    items:
                      properties:
                        description:
                          type: string
                        displayName:
                          type: string
                        from:
                          type: string
                        generate:
                          type: string
                        name:
                          type: string
                        required:
                          type: boolean
                        value:
                          x-kubernetes-int-or-string: true
                      required:
                      - name
                      type: object
                    type: array
          status:
            type: object
            properties:
              conditions:
                items:
                  properties:
                    lastTransitionTime:
                      format: date-time
                      type: string
                    message:
                      type: string
                    reason:
                      type: string
                    status:
                      type: string
                    type:
                      type: string
                  required:
                    - type
                  type: object
                type: array
              objects:
                items:
                  properties:
                    ref:
                      type: object
                      properties:
                        apiVersion:
                          type: string
                        fieldPath:
                          type: string
                        kind:
                          type: string
                        name:
                          type: string
                        namespace:
                          type: string
                        resourceVersion:
                          type: string
                        uid:
                          type: string
                  required:
                  - ref
                  type: object
                type: array
  subresources:
    status: {}
    
---

apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: registries.tmax.io
spec:
  group: tmax.io
  versions:
    - name: v1
      served: true
      storage: true
  scope: Namespaced
  names:
    plural: registries
    singular: registry
    kind: Registry
    shortNames:
    - reg
  preserveUnknownFields: false
  validation:
    openAPIV3Schema:
      type: object
      required: [spec]
      properties:
        spec:
          type: object
          required: [image, loginId, loginPassword, service, persistentVolumeClaim]
          description: registry information
          properties:
            image:
              type: string
            description:
              type: string
            loginId:
               type: string
            loginPassword:
               type: string
            service:
              type: object
              required: [type]
              properties:
                port:
                  type: integer
                  description: "external port (default: 443)"
                nodeIP:
                  type: string
                  description: "if service type is NodePort, set NodeIP to assign to the registry"
                nodePort:
                  type: integer
                  description: "if service type is NodePort, you can set 30000~32767"
                type:
                  type: string
                  enum: [ClusterIP, NodePort, LoadBalancer]
            persistentVolumeClaim:
              type: object
              required: [storageSize, storageClassName]
              properties:
                accessModes:
                  type: array
                  items:
                    type: string
                    enum: [ReadWriteOnce, ReadWriteMany]
                storageSize:
                  type: string
                  description: "enter the desired storage size (ex: 10Gi)"
                storageClassName:
                  type: string
                  description: "enter storage class name available (ex: csi-cephfs-sc)"
        status:
          type: object
          properties:
             conditions:
               type: array
               items:
                 type: object
                 required: [type]
                 properties:
                   lastTrasnsitionTime:
                     format: date-time
                     type: string
                   message:
                     type: string
                   reason:
                     type: string
                   status:
                     type: string
                   type:
                     type: string
             phase:
               type: string
  subresources:
    status: {}
  additionalPrinterColumns:
  - name: Image
    type: string
    description: Registry Image
    JSONPath: .spec.image
  - name: Capacity
    type: string
    description: Registry PVC Size
    JSONPath: .spec.persistentVolumeClaim.storageSize
  - name: Status
    type: string
    description: Registry Status
    JSONPath: .status.phase
  - name: Age
    type: date
    JSONPath: .metadata.creationTimestamp

---

apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: namespaceclaims.tmax.io
spec:
  group: tmax.io
  versions:
  - name: v1
    served: true
    storage: true
  scope: Cluster
  names:
    plural: namespaceclaims
    singular: namespaceclaim
    kind: NamespaceClaim
    shortNames:
    - nsc
  preserveUnknownFields: true
  validation:
    openAPIV3Schema:
        # Users use namespaceclaim to request namespace and quotas.
        # The spec of namespaceclaim is the same as resourcequota.
        # Admins can change the 'status' of the namespaceclaim.
        # If Admin change the Status to 'Success', a namespace and resourcequota are created.
        type: object
        required: [apiVersion,kind,metadata,spec]
        properties:
          apiVersion:
            type: string
          kind:
            type: string
          metadata:
            type: object
            properties:
              name:
                type: string
          spec:
            # Equal Resource Quota Spec
            type: object
            x-kubernetes-preserve-unknown-fields: true
          status:
            type: object
            properties:
              lastTransitionTime:
                format: date-time
                type: string
              message:
                type: string
              reason:
                type: string
              status:
                type: string
                enum:
                  - Awaiting
                  - Success
                  - Reject
                  - Error
  additionalPrinterColumns:
  - name: Status
    type: string
    JSONPath: .status.status
  - name: Reason
    type: string
    JSONPath: .status.reason
  subresources:
    status: {}

---

apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: resourcequotaclaims.tmax.io
spec:
  group: tmax.io
  versions:
  - name: v1
    served: true
    storage: true
  scope: Namespaced
  names:
    plural: resourcequotaclaims
    singular: resourcequotaclaim
    kind: ResourceQuotaClaim
    shortNames:
    - rqc
  preserveUnknownFields: true
  validation:
    openAPIV3Schema:
        # Users use resourcequotaclaim to modify quotas.
        # The spec of resourcequotaclaim is the same as resourcequota.
        # Admins can change the 'status' of the resourcequotaclaim.
        # If Admin change the Status to 'Success', resourcequota is updated.
        type: object
        required: [apiVersion,kind,metadata,spec]
        properties:
          apiVersion:
            type: string
          kind:
            type: string
          metadata:
            type: object
            properties:
              name:
                type: string
          spec:
            # Equal Resource Quota
            type: object
            x-kubernetes-preserve-unknown-fields: true
          status:
            type: object
            properties:
              lastTransitionTime:
                format: date-time
                type: string
              message:
                type: string
              reason:
                type: string
              status:
                type: string
                enum:
                  - Awaiting
                  - Success
                  - Reject
                  - Error
  additionalPrinterColumns:
  - name: Status
    type: string
    JSONPath: .status.status
  - name: Reason
    type: string
    JSONPath: .status.reason
  subresources:
    status: {}

---

apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: rolebindingclaims.tmax.io
spec:
  group: tmax.io
  versions:
  - name: v1
    served: true
    storage: true
  scope: Namespaced
  names:
    plural: rolebindingclaims
    singular: rolebindingclaim
    kind: RoleBindingClaim
    shortNames:
    - rbc
  preserveUnknownFields: true
  validation:
    openAPIV3Schema:
        # Users use rolebindingclaim to request rolebinding.
        # subject and roleRef of rolebindingclaim is the same as rolebinding.
        # Admins or Owner can change the 'status' of the rolebindingclaim.
        # If change the Status to 'Success', rolebinding is created.
        type: object
        required: [apiVersion,kind,metadata,subjects,roleRef]
        properties:
          apiVersion:
            type: string
          kind:
            type: string
          metadata:
            type: object
            properties:
              name:
                type: string
          subjects:
            # Equal RoleBinding Subjects Spec
            type: array
            items:
              type: object
              required: [kind,name]
              properties:
                kind:
                  type: string
                name:
                  type: string
                apiGroup:
                  type: string
          roleRef:
            # Equal RoleBinding roleRef Spec
            type: object
            required: [kind,name,apiGroup]
            properties:
              kind:
                type: string
              name:
                type: string
              apiGroup:
                type: string
          status:
            type: object
            properties:
              lastTransitionTime:
                format: date-time
                type: string
              message:
                type: string
              reason:
                type: string
              status:
                type: string
                enum:
                  - Awaiting
                  - Success
                  - Reject
                  - Error
  additionalPrinterColumns:
  - name: Status
    type: string
    JSONPath: .status.status
  - name: Reason
    type: string
    JSONPath: .status.reason
  subresources:
    status: {}
   
--- 
    
apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: clients.tmax.io
spec:
  group: tmax.io
  versions:
    - name: v1
      served: true
      storage: true
  scope: Cluster
  names:
    plural: clients
    singular: client
    kind: Client
    shortNames:
    - client
  preserveUnknownFields: false
  validation:
    openAPIV3Schema:
      type: object
      required: [clientInfo]
      properties:
        clientInfo:
          type: object
          required: [appName, originUri, redirectUri, clientId, clientSecret]
          description: ClientInfo contains Client information
          properties:
            clientId:
              type: string
            clientSecret:
              type: string  
            appName:
              type: string
            originUri:
              type: string
            redirectUri:
              type: string
        status:
         type: object
         properties:
           lastTransitionTime:
             format: date-time
             type: string
           message:
             type: string
           reason:
             type: string
           status:
             type: string
             enum:
               - active
               - blockedr
  additionalPrinterColumns:
  - name: Status
    type: string
    JSONPath: .status.status
  subresources:
    status: {}